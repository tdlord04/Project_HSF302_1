<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/home}" lang="vi">
<head>
    <meta charset="UTF-8">
    <title layout:title="${job.id != null ? 'Ch·ªânh s·ª≠a tin tuy·ªÉn d·ª•ng' : 'T·∫°o tin tuy·ªÉn d·ª•ng'}">
        <span th:text="${job.id != null ? 'Ch·ªânh s·ª≠a tin tuy·ªÉn d·ª•ng' : 'T·∫°o tin tuy·ªÉn d·ª•ng'}"></span>
    </title>
</head>

<body class="bg-light">

<section layout:fragment="content">
    <div class="container mt-5 mb-5">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 th:text="${job.id != null ? '‚úèÔ∏è Ch·ªânh s·ª≠a tin tuy·ªÉn d·ª•ng' : 'üÜï T·∫°o tin tuy·ªÉn d·ª•ng'}"></h4>
            </div>

            <div class="card-body">
                <form th:action="@{/job-postings/form/save}" th:object="${job}" method="post">
                    <input type="hidden" th:field="*{id}"/>

                    <!-- TI√äU ƒê·ªÄ -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">T√™n v·ªã tr√≠</label>
                        <input th:field="*{jobTitle}" class="form-control" placeholder="Nh·∫≠p t√™n v·ªã tr√≠ tuy·ªÉn d·ª•ng">
                        <div th:if="${#fields.hasErrors('jobTitle')}" th:errors="*{jobTitle}" class="text-danger small"></div>
                    </div>

                    <!-- ƒê·ªäA ƒêI·ªÇM & M·ª®C L∆Ø∆†NG -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">ƒê·ªãa ƒëi·ªÉm l√†m vi·ªác</label>
                            <input th:field="*{location}" class="form-control" placeholder="Nh·∫≠p ƒë·ªãa ƒëi·ªÉm l√†m vi·ªác">
                            <div th:if="${#fields.hasErrors('location')}" th:errors="*{location}" class="text-danger small"></div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">M·ª©c l∆∞∆°ng</label>
                            <input th:field="*{salaryRange}" class="form-control" placeholder="V√≠ d·ª•: 15‚Äì25 tri·ªáu VNƒê">
                            <div th:if="${#fields.hasErrors('salaryRange')}" th:errors="*{salaryRange}" class="text-danger small"></div>
                        </div>
                    </div>

                    <!-- M√î T·∫¢ -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">M√¥ t·∫£ c√¥ng vi·ªác</label>
                        <textarea th:field="*{description}" class="form-control" rows="5"></textarea>
                        <div th:if="${#fields.hasErrors('description')}" th:errors="*{description}" class="text-danger small"></div>
                    </div>

                    <!-- Y√äU C·∫¶U -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Y√™u c·∫ßu c√¥ng vi·ªác</label>
                        <textarea th:field="*{requirements}" class="form-control" rows="5"></textarea>
                        <div th:if="${#fields.hasErrors('requirements')}" th:errors="*{requirements}" class="text-danger small"></div>
                    </div>

                    <!-- C√îNG TY & TR·∫†NG TH√ÅI -->
                    <div class="row">
                        <!-- Combo C√¥ng ty -->
                        <div class="col-md-6 mb-3 combo-container">
                            <label class="form-label fw-semibold">C√¥ng ty</label>
                            <input type="hidden" th:field="*{companyId}" id="companyId">
                            <input type="text" id="companyInput" class="form-control" placeholder="T√¨m ho·∫∑c ch·ªçn c√¥ng ty">
                            <div id="companyList" class="combo-list">
                                <div class="combo-item" th:each="c : ${companies}"
                                     th:data-id="${c.id}" th:text="${c.name}"></div>
                            </div>
                            <div th:if="${#fields.hasErrors('companyId')}" th:errors="*{companyId}" class="text-danger small"></div>
                        </div>

                        <!-- Combo Tr·∫°ng th√°i -->
                        <div class="col-md-6 mb-3 combo-container">
                            <label class="form-label fw-semibold">Tr·∫°ng th√°i</label>
                            <input type="hidden" th:field="*{status}" id="statusVal">
                            <input type="text" id="statusInput" class="form-control" placeholder="T√¨m ho·∫∑c ch·ªçn tr·∫°ng th√°i">
                            <div id="statusList" class="combo-list">
                                <div class="combo-item" th:each="s : ${statuses}"
                                     th:data-id="${s}" th:text="${s}"></div>
                            </div>
                            <div th:if="${#fields.hasErrors('status')}" th:errors="*{status}" class="text-danger small"></div>
                        </div>
                    </div>

                    <div class="text-end mt-4">
                        <button type="submit" class="btn btn-success px-4">üíæ L∆∞u</button>
                        <a th:href="@{/job-postings}" class="btn btn-secondary px-4">H·ªßy</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <style>
        .combo-container {
            position: relative;
        }
        .combo-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
            background: #fff;
            border: 1px solid #ced4da;
            border-radius: 0 0 .375rem .375rem;
            max-height: 180px;
            overflow-y: auto;
            display: none;
        }
        .combo-item {
            padding: 8px 12px;
            cursor: pointer;
        }
        .combo-item:hover {
            background-color: #0d6efd;
            color: #fff;
        }
    </style>

    <!-- ‚úÖ CKEDITOR -->
    <script src="https://cdn.ckeditor.com/4.21.0/standard-all/ckeditor.js"></script>
    <script>
        CKEDITOR.config.notification = false;
        ['description', 'requirements'].forEach(id => {
            CKEDITOR.replace(id, {
                extraPlugins: 'autogrow',
                autoGrow_minHeight: 150,
                autoGrow_maxHeight: 700,
                removePlugins: 'resize,notification',
                contentsCss: [
                    'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css',
                    'body { font-size: 14px; color: #212529; line-height: 1.6; }'
                ]
            });
        });
    </script>

    <!-- ‚úÖ COMBO BOX SCRIPT -->
    <script>
        function initCombo(inputId, listId, hiddenId) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            const hidden = document.getElementById(hiddenId);
            const items = Array.from(list.querySelectorAll('.combo-item'));

            input.addEventListener('focus', () => list.style.display = 'block');
            input.addEventListener('blur', () => setTimeout(() => list.style.display = 'none', 150));

            input.addEventListener('input', () => {
                const value = input.value.toLowerCase();
                items.forEach(item => {
                    item.style.display = item.textContent.toLowerCase().includes(value) ? 'block' : 'none';
                });
                hidden.value = ''; // reset khi g√µ tay
            });

            items.forEach(item => {
                item.addEventListener('mousedown', () => {
                    input.value = item.textContent;
                    hidden.value = item.dataset.id;
                    list.style.display = 'none';
                });
            });

            // ‚úÖ Khi load form edit, hi·ªÉn th·ªã gi√° tr·ªã c≈©
            const preloadValue = hidden.value;
            if (preloadValue) {
                const matchItem = items.find(i => i.dataset.id === preloadValue);
                if (matchItem) input.value = matchItem.textContent;
            }
        }

        // ‚úÖ Kh·ªüi t·∫°o combo
        document.addEventListener('DOMContentLoaded', () => {
            initCombo('companyInput', 'companyList', 'companyId');
            initCombo('statusInput', 'statusList', 'statusVal');

            // ‚úÖ FIX CH√çNH: ƒë·∫£m b·∫£o hidden c·∫≠p nh·∫≠t tr∆∞·ªõc khi submit
            const form = document.querySelector('form');
            form.addEventListener('submit', (e) => {
                const companyInput = document.getElementById('companyInput');
                const companyHidden = document.getElementById('companyId');
                const companyMatch = Array.from(document.querySelectorAll('#companyList .combo-item'))
                    .find(i => i.textContent === companyInput.value);
                if (companyMatch) companyHidden.value = companyMatch.dataset.id;

                const statusInput = document.getElementById('statusInput');
                const statusHidden = document.getElementById('statusVal');
                const statusMatch = Array.from(document.querySelectorAll('#statusList .combo-item'))
                    .find(i => i.textContent === statusInput.value);
                if (statusMatch) statusHidden.value = statusMatch.dataset.id;
            });
        });
    </script>


</section>
</body>
</html>
