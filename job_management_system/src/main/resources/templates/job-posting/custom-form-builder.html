<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/home}" lang="vi">

<head>
    <meta charset="UTF-8">
    <title layout:title="${form.id != null ? 'S·ª≠a form t√πy ch·ªânh' : 'T·∫°o form t√πy ch·ªânh'}">${form.id != null ? 'S·ª≠a form t√πy ch·ªânh' : 'T·∫°o form t√πy ch·ªânh'}</title>
</head>

<body>
<section layout:fragment="content">
    <div class="container mt-5 mb-5">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0" th:text="${form.id != null ? 'S·ª≠a form t√πy ch·ªânh' : 'T·∫°o form t√πy ch·ªânh'}"></h4>
                <a th:href="@{'/job-postings/' + ${form.jobPostingId}}" class="btn btn-light btn-sm">‚¨Ö Quay l·∫°i</a>
            </div>

            <div class="card-body">
                <form th:action="@{/custom-forms/save}" th:object="${form}" method="post" id="customForm">
                    <input type="hidden" th:field="*{id}">
                    <input type="hidden" th:field="*{jobPostingId}">
                    <input type="hidden" name="jobTitle" th:value="${jobTitle}">

                    <div class="mb-3">
                        <label class="form-label fw-semibold">B√†i ƒëƒÉng tuy·ªÉn d·ª•ng</label>
                        <input type="text" class="form-control bg-light" th:value="${jobTitle}" readonly>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">T√™n form</label>
                        <input th:field="*{formName}" class="form-control" placeholder="V√≠ d·ª•: M·∫´u ·ª©ng tuy·ªÉn - L·∫≠p tr√¨nh vi√™n">
                        <div th:if="${#fields.hasErrors('formName')}" th:errors="*{formName}" class="text-danger small"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">M√¥ t·∫£</label>
                        <textarea th:field="*{description}" class="form-control" rows="3"
                                  placeholder="M√¥ t·∫£ ng·∫Øn g·ªçn v·ªÅ form n√†y"></textarea>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" th:field="*{active}" id="isActive">
                        <label class="form-check-label" for="isActive">K√≠ch ho·∫°t</label>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="text-primary mb-0">üß© Xem tr∆∞·ªõc form</h5>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="btnAdd">‚ûï Th√™m m·ª•c</button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-bordered align-middle bg-white" id="previewTable">
                            <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Ti√™u ƒë·ªÅ</th>
                                <th>M√¥ t·∫£</th>
                                <th>Thao t√°c</th>
                            </tr>
                            </thead>
                            <tbody id="previewBody"></tbody>
                        </table>
                    </div>

                    <textarea th:field="*{formStructureJson}" id="formStructureJson" class="d-none"></textarea>

                    <div class="text-end mt-3">
                        <button type="submit" class="btn btn-success px-4">üíæ L∆∞u</button>
                        <a th:href="@{'/job-postings/' + ${form.jobPostingId}}" class="btn btn-secondary px-4">H·ªßy</a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal th√™m m·ª•c -->
        <div class="modal fade" id="addModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="addItemForm" onsubmit="return false;">
                        <div class="modal-header">
                            <h5 class="modal-title">Th√™m m·ª•c</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <label class="form-label">Ti√™u ƒë·ªÅ <span class="text-danger">*</span></label>
                            <input id="inpTitle" class="form-control" required>
                            <label class="form-label mt-2">M√¥ t·∫£ (kh√¥ng b·∫Øt bu·ªôc)</label>
                            <textarea id="inpDesc" class="form-control" rows="3"></textarea>
                            <div id="addErr" class="text-danger small mt-2 d-none">Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ</div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                            <button type="submit" class="btn btn-primary" id="btnAddConfirm">Th√™m</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <style>
        .item-row:hover .btn-remove { opacity: 1; }
        .btn-remove { opacity: 0; transition: opacity .15s; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // State
        let items = [];

        // Elements
        const previewBody = document.getElementById('previewBody');
        const hiddenJson = document.getElementById('formStructureJson');
        const btnAdd = document.getElementById('btnAdd');

        // Modal
        const addModalEl = document.getElementById('addModal');
        const addModal = new bootstrap.Modal(addModalEl);
        const addForm = document.getElementById('addItemForm');
        const inpTitle = document.getElementById('inpTitle');
        const inpDesc = document.getElementById('inpDesc');
        const addErr = document.getElementById('addErr');

        // Load existing JSON (Edit mode)
        try {
            if (hiddenJson.value && hiddenJson.value.trim().length > 0) {
                const parsed = JSON.parse(hiddenJson.value);
                if (Array.isArray(parsed))
                    items = parsed.map(x => ({
                        title: x.title || '',
                        description: x.description || ''
                    }));
            }
        } catch (e) {
            console.warn('Invalid existing JSON, start empty:', e);
        }

        // Render function
        function render() {
            previewBody.innerHTML = '';

            if (items.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="4" class="text-center text-muted">
            No items. Click "Add Item" to start.
        </td>`;
                previewBody.appendChild(tr);
                hiddenJson.value = '[]';
                return;
            }

            items.forEach((it, idx) => {
                const tr = document.createElement('tr');
                tr.className = 'item-row';
                tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${escapeHtml(it.title)}</td>
            <td>${it.description ? escapeHtml(it.description) : '<span class="text-muted">‚Äî</span>'}</td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger btn-remove" title="Remove">‚úñ</button>
            </td>
        `;
                tr.querySelector('.btn-remove').addEventListener('click', () => {
                    items.splice(idx, 1);
                    render();
                });
                previewBody.appendChild(tr);
            });

            hiddenJson.value = JSON.stringify(items);
        }

        function escapeHtml(str) {
            return String(str).replace(/[&<>"']/g, s => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[s]));
        }

        // Add flow
        btnAdd.addEventListener('click', () => {
            inpTitle.value = '';
            inpDesc.value = '';
            addErr.classList.add('d-none');
            addModal.show();
        });

        addForm.addEventListener('submit', () => {
            const title = inpTitle.value.trim();
            const desc = inpDesc.value.trim();

            if (!title) {
                addErr.classList.remove('d-none');
                return;
            }

            items.push({ title, description: desc || '' });
            addModal.hide();
            render();
        });

        // Validate before submit (at least 0..n items ‚Äì t√πy nghi·ªáp v·ª•, ·ªü ƒë√¢y cho ph√©p r·ªóng)
        document.getElementById('customForm').addEventListener('submit', (e) => {
            // N·∫øu mu·ªën b·∫Øt bu·ªôc >=1 m·ª•c:
            // if (items.length === 0) {
            //     e.preventDefault();
            //     alert('Please add at least one item.');
            //     return;
            // }
            hiddenJson.value = JSON.stringify(items);
        });

        // Initial render
        render();
    </script>

</section>



</body>
</html>
